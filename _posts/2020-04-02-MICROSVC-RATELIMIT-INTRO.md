---
layout:     post
title:      微服务基础之限流（RateLimit）
subtitle:
date:       2020-04-02
author:     pandaychen
header-img:
catalog: true
category:   false
tags:
    - 限流
---


##  0x00    微服务中的限流

这篇博客来介绍下微服务中的服务限流（Ratelimit），它是保证服务稳定的基础组件之一。其他的限流方式还包含熔断降级。微服务中的限流主要指业务代码的逻辑限流。
通常，限流策略相较于熔断，使用的更为广泛一些，因为限流的同时可以对其他（被限制）服务请求进行排队处理，而不是像熔断策略直接拒绝掉这些被限制的请求。当然了，简单的处理方式就是被限制的流量，可以根据具体的业务逻辑去处理，直接返回错误或者返回默认值等等。<!--  -->

##  0x01	限流的应用场景
1.	秒杀
2.	恶意刷单
3.	服务路径上关键服务挂掉导致的雪崩问题

比如，一个服务 A 的接口可能被 BCDE 多个服务进行调用，在 B 服务发生突发流量时，直接把 A 服务给调用挂了，导致 A 服务对 CDE 也无法提供服务。解决方案有两种：
1.  每个 Caller 采用线程池进行资源隔离
2.  使用限流手段对每个 Caller 进行限流

##	0x02	限流算法的实现

本小节，介绍常用的限流算法实现，无论是何种算法，都可以抽象成下面这张图，请求方必须拿到请求的令牌，才可以访问到相应的应用。基于令牌的算法实现方式，常见的有这几种限流算法：

![image](https://s1.ax1x.com/2020/04/09/G42Bp4.png)

1.  计数器算法
采用计数器实现限流有点简单粗暴，一般我们会限制一秒钟的能够通过的请求数，比如限流 qps 为 100，算法的实现思路就是从第一个请求进来开始计时，在接下去的 1s 内，每来一个请求，就把计数加 1，如果累加的数字达到了 100，那么后续的请求就会被全部拒绝。等到 1s 结束后，把计数恢复成 0，重新开始计数。
具体的实现可以是这样的：对于每次服务调用，可以通过 AtomicLong#incrementAndGet() 方法来给计数器加 1 并返回最新值，通过这个最新值和阈值进行比较。
这种实现方式，相信大家都知道有一个弊端：如果我在单位时间 1s 内的前 10ms，已经通过了 100 个请求，那后面的 990ms，只能眼巴巴的把请求拒绝，我们把这种现象称为 “突刺现象”
2.  漏桶算法
为了消除 "突刺现象"，可以采用漏桶算法实现限流，漏桶算法这个名字就很形象，算法内部有一个容器，类似生活用到的漏斗，当请求进来时，相当于水倒入漏斗，然后从下端小口慢慢匀速的流出。不管上面流量多大，下面流出的速度始终保持不变。
不管服务调用方多么不稳定，通过漏桶算法进行限流，每 10 毫秒处理一次请求。因为处理的速度是固定的，请求进来的速度是未知的，可能突然进来很多请求，没来得及处理的请求就先放在桶里，既然是个桶，肯定是有容量上限，如果桶满了，那么新进来的请求就丢弃。

在算法实现方面，可以准备一个队列，用来保存请求，另外通过一个线程池定期从队列中获取请求并执行，可以一次性获取多个并发执行。
这种算法，在使用过后也存在弊端：无法应对短时间的突发流量。
3.  令牌桶算法
从某种意义上讲，令牌桶算法是对漏桶算法的一种改进，桶算法能够限制请求调用的速率，而令牌桶算法能够在限制调用的平均速率的同时还允许一定程度的突发调用。

![image](https://s1.ax1x.com/2020/04/09/G4gEZV.png)

在令牌桶算法中，存在一个桶，用来存放固定数量的令牌。算法中存在一种机制，以一定的速率往桶中放令牌。每次请求调用需要先获取令牌，只有拿到令牌，才有机会继续执行，否则选择选择等待可用的令牌、或者直接拒绝。
放令牌这个动作是持续不断的进行，如果桶中令牌数达到上限，就丢弃令牌，所以就存在这种情况，桶中一直有大量的可用令牌，这时进来的请求就可以直接拿到令牌执行，比如设置 qps 为 100，那么限流器初始化完成一秒后，桶中就已经有 100 个令牌了，这时服务还没完全启动好，等启动完成对外提供服务时，该限流器可以抵挡瞬时的 100 个请求。所以，只有桶中没有令牌时，请求才会进行等待，最后相当于以一定的速率执行。



##	0x	参考
-	[Go 语言高级编程 (Advanced Go Programming)- 5.6 Ratelimit 服务流量限制](https://chai2010.cn/advanced-go-programming-book/ch5-web/ch5-06-ratelimit.html)
-   [Golang 标准库限流器 time/rate 使用介绍](https://www.cyhone.com/articles/usage-of-golang-rate/)